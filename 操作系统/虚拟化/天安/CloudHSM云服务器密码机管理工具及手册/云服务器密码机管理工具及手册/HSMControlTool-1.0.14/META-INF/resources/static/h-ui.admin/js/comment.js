$(function(){document.onkeydown=function(moz_ev){var ev=null;if(window.event){ev=window.event;}else{ev=moz_ev;}if(ev!=null&&ev.ctrlKey&&ev.keyCode==13){var quick_isFocus=$("#quickComment").is(":focus");var comment_isFocus=$("#textareaComment").is(":focus");if(true==comment_isFocus){$("#textCommentSubmit").click();}if(true==quick_isFocus){$("#textCommentSubmitQuick").click();}}};commentQuickReply(".reply");showHide(".comment_list","",".jubao");visibleOrNot(".operate_box",".noGoods","visibility");visibleOrNot("blockquote",".comment_action","display");tab(".tab_comment_li",".tab_info","current_item","click");openClose(".seaAll","","comments");popUp("#textareaComment","#pop-login","");popUp(".comment_tips","#pop-login","");comment_share_to_sina("i.check");$(".comment_showAll").click(function(){$(this).siblings("blockquote:hidden").show();$(this).siblings("blockquote:hidden").find(".seaAll").show();$(this).remove();});var txt3='"><i class="icon-loginright"></i> 提交成功。',txt4='"><i class="icon-loginright"></i> 提交成功。若您的评论未显示，不是小编手快删帖，而是您的评论需审核，请谅解',txt5='"><i class="icon-loginright"></i> 为维护良好讨论环境，新注册用户的评论需人工审核后再显示，请谅解';$submit=$("#commentform #textCommentSubmit");$submitQuickBtn=$("#commentquickform #textCommentSubmitQuick");$("#commentform").submit(function(){if($.trim($("#textareaComment").val())==""||$.trim($("#textareaComment").val())==$("#textareaComment").attr("default_data")){if($("#error").is(":hidden")){$("#error").html("您是不是忘了说点什么？").slideDown().delay(3000).slideUp();}}else{submit_comment(0);}return false;});$("#commentquickform").submit(function(){if($.trim($("#quickComment").val())==""||$.trim($("#quickComment").val())==$("#textareaComment").attr("default_data")){if($("#quick_error").is(":hidden")){$("#quick_error").html("您是不是忘了说点什么？").slideDown().delay(3000).slideUp();}}else{submit_comment(1);}return false;});var wait=15,submit_val=$submit.html(),waitquick=15,quick_submit_val=$submitQuickBtn.html();function countdown(){if(wait>0){$submit.html(wait);wait--;setTimeout(countdown,1000);}else{$submit.html(submit_val).attr("disabled",false).removeClass("btn_subGrey").addClass("btn_sub").fadeTo("slow",1);wait=15;}}function quickcountdown(){if(waitquick>0){$submitQuickBtn.html(waitquick);waitquick--;setTimeout(quickcountdown,1000);}else{$submitQuickBtn.html(quick_submit_val).attr("disabled",false).removeClass("btn_subGrey").addClass("btn_sub").fadeTo("slow",1);waitquick=15;}}function submit_comment(isQuickSumit){var errorContainerId="error";var btn=$submit;var loadingImg=$("#loading");if(1==isQuickSumit){var formObj=$("#commentquickform");errorContainerId="quick_error";btn=$submitQuickBtn;loadingImg=$("#loadingquick");btn.attr("disabled",true).removeClass("btn_sub").addClass("btn_subGrey").fadeTo("slow",0.5);}else{var formObj=$("#commentform");btn.attr("disabled",true).removeClass("btn_sub").addClass("btn_subGrey").fadeTo("slow",0.5);}loadingImg.show();$.ajax({type:"POST",url:"/ajax_set_comment",data:formObj.serialize(),dataType:"json",success:function(data){var result=eval(data);loadingImg.hide();if(0==result.error_code||6==result.error_code){var div_new=$(".comment_wrap .tab_nav").find(".tab_comment_li:first");div_new.siblings().removeClass("current_item");div_new.addClass("current_item");$("#commentTabBlockNew").css("display","");$("#commentTabBlockHot").css("display","none");if(result.error_msg.sina_uri){window.location.href=result.error_msg.sina_uri;return;}var the_floor=0;var floor_grey=$("#commentTabBlockNew ul.comment_listBox li:first .grey").html();if(floor_grey){the_floor=floor_grey.split("楼")[0];}(the_floor)?the_floor=parseInt(the_floor)+1:the_floor=0;var ok_htm='\n<div id="success_1'+txt3+"</div>\n";if(6==result.error_code){ok_htm='\n<div id="success_1'+txt4+"</div>\n";}var new_comment_html="";new_comment_html+='<li id="li_comment_4700621" class="comment_list">';new_comment_html+='<div class="comment_avatar">';new_comment_html+='<a href="javascript:void(0);" class="userPic"><img src="'+result.error_msg.head+'" width="36" height="36"/></a>';new_comment_html+=(the_floor)?'<span class="grey">'+the_floor+"楼</span>":"";new_comment_html+="</div>";new_comment_html+='<div class="comment_conBox">';new_comment_html+='<div class="comment_avatar_time"><div class="time">'+result.error_msg.format_date+"</div>";if(result.error_msg.is_anonymous){new_comment_html+='<span class="grey">'+result.error_msg.comment_author+"</span>";}else{new_comment_html+='<a href="javascript:void(0);" class="a_underline user_name">'+result.error_msg.comment_author+"</a>";}new_comment_html+="</div>";new_comment_html+='<div class="comment_conWrap">';new_comment_html+='<div class="comment_con"><p>'+result.error_msg.comment_content+"</p></div>";new_comment_html+=ok_htm;new_comment_html+='<div class="blankDiv"></div>';new_comment_html+="</div>";new_comment_html+="</div>";new_comment_html+='<div class="clear"></div>';new_comment_html+="</li>";$("#comment .tab_nav:first").css("display","block");$("#li_comment_new").after(new_comment_html);setTimeout(function(){$("#success_1").remove();},3000);$body=(window.opera)?(document.compatMode=="CSS1Compat"?$("html"):$("body")):$("html,body");$body.animate({scrollTop:$("#panelTitle").offset().top-30},900);if(1==isQuickSumit){quickcountdown();}else{countdown();}if(1==isQuickSumit){$("#quickComment").val("");}else{$("#textareaComment").val("");}$(".commentNum").each(function(){$(this).html(parseInt($(this).html())+1);});var score=result.error_msg.post_points?result.error_msg.post_points:0;var exp=result.error_msg.post_experience?result.error_msg.post_experience:0;var gold=result.error_msg.post_gold?result.error_msg.post_gold:0;var mana=result.error_msg.post_prestige?result.error_msg.post_prestige:0;if(score!=0||exp!=0||gold!=0||mana!=0){var scoreDom=(score==0)?"":'<span class="comment_score">积分：<em>'+score+"</em></span>";var expDom=(exp==0)?"":'<span class="comment_exp">经验：<em>'+exp+"</em></span>";var goldDom=(gold==0)?"":'<span class="comment_gold">金币：<em>'+gold+"</em></span>";var manaDom=(mana==0)?"":'<span class="comment_mana">威望：<em>'+mana+"</em></span>";$("#pop-comment-score").find(".pop_comment_info").html(scoreDom+expDom+goldDom+manaDom);popUp("","#pop-comment-score","成功发表评论");}}else{if(7==result.error_code){var msg=result.error_msg;$("body").append('<div class="pop pop_no_title" id="pop-scorenotenough"><i class="pop-close icon-cross-lighter"><!--[if lt IE 8]>x<![endif]--></i><div class="pop-content twoLine"><i class="icon-logintanhao"><!--[if lt IE 8]>404<![endif]--></i><p class="pop_info"></p></div></div>');popUp("","#pop-scorenotenough",msg);}else{var no_htm=result.error_msg;if(5==result.error_code){no_htm="请登录后发表评论";}$("#"+errorContainerId).slideDown().html(no_htm);setTimeout(function(){btn.attr("disabled",false).removeClass("btn_subGrey").addClass("btn_sub").fadeTo("slow",1);$("#"+errorContainerId).slideUp();},3000);}}}});}$(".jubao").each(function(){if($(this).attr("id")){var report_cid=$(this).attr("id").split("_")[1];if(report_cid==""||report_cid==null||report_cid=="0"){return false;}var result_json=getCookie(comment_report_cookiename);if(result_json){var comment_report_cookie_list=json_decode(result_json);if(comment_report_cookie_list){for(var i in comment_report_cookie_list){if(comment_report_cookie_list[i]&&comment_report_cookie_list[i]==report_cid){has_report_omment(report_cid);}}}}}});$(".jubao").click(function(){if($(this).attr("id")){var report_cid=$(this).attr("id").split("_")[1];if(report_cid==""||report_cid==null||report_cid=="0"){return false;}var boo_in_cookie=getBooInCookieArr1(comment_report_cookiename,report_cid);if(boo_in_cookie){setCookieArr1(comment_report_cookiename,report_cid,604800,"/",smzdm_domain);popUp("","#pop-status-fail-twoLine","您已经举报过了，我们正在处理，多谢反馈！");return false;}var report_type=1;var report_text="";popPosition("#pop-report");$("#pop-report").show(function(){$(this).find("input[type='radio']").removeAttr("checked").click(function(){var n=$(this).attr("id").split("_")[2];report_type=n;if(n==9){$("#pop_report_opinion").show();$("#pop_report_submit").attr("disabled","disabled").removeClass("btn_login").addClass("btn_grey");$("#pop_report_opinion").find("textarea").bind("keyup mouseup",function(){var len=$(this).val().length;report_text=$("#pop_report_opinion").find("textarea").val();if(len>=10){$("#pop_report_submit").removeAttr("disabled").removeClass("btn_grey").addClass("btn_login");}});}else{report_text="";if($("#pop_report_opinion").is(":visible")){$("#pop_report_opinion").hide();$("#pop_report_submit").removeAttr("disabled").removeClass("btn_grey").addClass("btn_login");}}});});$("#cover").show();popClose("#pop-report");$("#pop_report_submit").unbind("click").click(function(){$("#pop-report,#cover").hide();$.ajax({type:"POST",url:"/ajax_comment_report",data:"type="+report_type+"&content="+report_text+"&cid="+report_cid,dataType:"json",success:function(data){var result=eval(data);if(0==result.error_code){has_report_omment(report_cid);setCookieArr1(comment_report_cookiename,report_cid,604800,"/",smzdm_domain);popUp("","#pop-status-success","举报成功！");}else{popUp("","#pop-status-failed","举报失败！");}return;}});});return;}});$(".atta").click(function(){if(parseInt($("#log_status").val())!=1){popPosition("#pop-login");$("#pop-login,#cover").show();popClose("#pop-login");}else{$(window).scrollTop($("#comments").offset().top-50);var textcomment_obj=$("#textareaComment");if(textcomment_obj.length>0){var author=$(this).attr("title");var output=$.trim(textcomment_obj.val());if(output==default_data){output=author+" ";}else{var out_arr=output.split(" ");var flag=true;for(i=0;i<out_arr.length;i++){if(author==out_arr[i]){flag=false;break;}}if(flag){output=author+" "+output+" ";}else{output+=" ";}}textcomment_obj.focus().val(output);return true;}}return true;});});function has_report_omment(a){$("#report_"+a).removeAttr("onclick").addClass("comment-report").html("已举报");return;}function get_rating_num(b,f,e){var d="cdc_support_"+f;if(0==e){d="cdc_oppose_"+f;}var a=$("#li_comment_"+b+" #"+d+":first span").html();if(a){var c=a.split("(")[1];a=c.split(")")[0];(a)?a=parseInt(a):a=0;}else{a=0;}return a;}function has_rating_omment(d,b,a,c){if(1==b){$("#comment .tab_info .comment_listBox li #cdc_support_"+d).removeAttr("onclick").addClass("current").html("顶<span>("+a+")</span>");$("#comment .tab_info .comment_listBox li #cdc_oppose_"+d).removeAttr("onclick").removeClass("current");}else{$("#comment .tab_info .comment_listBox li #cdc_support_"+d).removeAttr("onclick").removeClass("current");$("#comment .tab_info .comment_listBox li #cdc_oppose_"+d).removeAttr("onclick").addClass("current").html("踩<span>("+c+")</span>");}return;}function init_smile(){$(".icon-small").each(function(){$(this).click(function(){$(".smileLayerBg").hide();if($(this).attr("isclick")=="1"){$(this).removeAttr("isclick");}else{$(".icon-small").each(function(){$(this).removeAttr("isclick");});$(this).attr("isclick","1");var a=$(this).parent();a.find(".smileLayerBg").show();a.find(".smileLayerBg .smileBox").hide().eq(0).show();a.find(".smileLayerBg .smilePage a").removeAttr("class").eq(0).attr("class","current");}});});$(".smilePage a").click(function(){$(this).addClass("current").siblings().removeClass("current");$(".smileBox").hide().eq($(".smilePage a").index(this)).show();});$(".smileLayerBg li a").each(function(){$(this).click(function(){var a=$(this).parent().parent().parent().parent();var c=a.parent().parent().find("textarea:first");a.find(".smileLayerBg").css("display","none");a.find(".icon-small").removeAttr("isclick");var d=c.attr("default");var e=c.val();if(e==default_data){e="";}var b=e;if(d){var b=e.replace(d,"");}c.val(b);c.insertContent($(this).attr("default-data"));});});return false;}function init_comment_rating(){$(".dingNum").each(function(){if($(this).attr("id")){var c=$(this).attr("id").split("_")[2];if(c==""||c==null||c=="0"){return false;}var b=getCookie(comment_rating_cookiename);if(b){var d=json_decode(b);if(d){for(var a in d){if(d[a]&&d[a][0]&&d[a][0]==c){if("1"==d[a][1]){$("#comment .tab_info .comment_listBox li #cdc_support_"+c).removeAttr("onclick").removeClass("current").addClass("current");$("#comment .tab_info .comment_listBox li #cdc_oppose_"+c).removeAttr("onclick").removeClass("current");}else{$("#comment .tab_info .comment_listBox li #cdc_support_"+c).removeAttr("onclick").removeClass("current");$("#comment .tab_info .comment_listBox li #cdc_oppose_"+c).removeAttr("onclick").removeClass("current").addClass("current");}}}}}}});}function comment_rating_ajax(type,rating,cid,pid,licid){var dingnum=get_rating_num(licid,cid,1);var cainum=get_rating_num(licid,cid,0);var boo_in_cookie=getBooInCookieArr2(comment_rating_cookiename,cid);if(boo_in_cookie){has_rating_omment(cid,rating,dingnum,cainum);setCookieArr2(comment_rating_cookiename,cid,rating,604800,"/",smzdm_domain);alert("您已打分");return false;}$.ajax({type:"POST",url:"/ajax_comment_rating",data:"cid="+cid+"&rating="+rating,dataType:"json",success:function(data){var result=eval(data);if(0==result.error_code){if(rating==0){cainum=cainum+1;}else{dingnum=dingnum+1;}has_rating_omment(cid,rating,dingnum,cainum);setCookieArr2(comment_rating_cookiename,cid,rating,604800,"/",smzdm_domain);}return;}});return;}function commentDelete(b,a){var c=b;if(window.confirm("确定删除该评论？")){$.ajax({type:"POST",url:"/ajax_off_comment",data:"cid="+c+"&act="+a,dataType:"json",success:function(d){if(d.error_code==0){$(".comment_listBox").find("#li_comment_"+c).remove();$(".comment_listBox").find("[blockquote_cid='"+c+"']").remove();popUp("","#pop-status-success","删除成功");}}});}}(function(a){a.fn.extend({insertContent:function(j,k){var g=a(this)[0];if(document.selection){this.focus();var d=document.selection.createRange();d.text=j;this.focus();d.moveStart("character",-e);var f=d.text.length;if(arguments.length==2){var e=g.value.length;d.moveEnd("character",f+k);k<=0?d.moveStart("character",f-2*k-j.length):d.moveStart("character",f-k-j.length);d.select();}}else{if(g.selectionStart||g.selectionStart=="0"){var h=g.selectionStart;var b=g.selectionEnd;var c=g.scrollTop;g.value=g.value.substring(0,h)+j+g.value.substring(b,g.value.length);this.focus();g.selectionStart=h+j.length;g.selectionEnd=h+j.length;g.scrollTop=c;if(arguments.length==2){g.setSelectionRange(h-k,g.selectionEnd+k);this.focus();}}else{this.value+=j;this.focus();}}}});})(jQuery);function clearReplyCss(){$("#quickComment").val("");}function commentQuickReply(a){$(a).click(function(){if(parseInt($("#log_status").val())!=1){popPosition("#pop-login");$("#pop-login").show();$("#cover").show();popClose("#pop-login");}else{clearReplyCss();var b=$("#quickReply");var d=0;if($(this).attr("id")){d=$(this).attr("id").split("_")[2];if(d==""||d==null||d=="0"||d==0){d=0;}b.find("#parentid").val(d);}var c=$(this).parent().parent(".comment_conWrap").find(".blankDiv");if($(c).html()==""){$(c).html(b);$("#quickReply").show();$(this).parent(".comment_action").css({display:"block",visibility:"visible"});}else{$("#quickReplyDiv").html(b);}}});}function visibleOrNot(b,a,c){$(b).hover(function(){if(c="visibility"){$(this).children().find(a).css("visibility","visible");}else{if(c="display"){$(this).children().find(a).css("display","block");}}},function(){if(c="visibility"){$(this).children().find(a).css("visibility","hidden");}else{if(c="display"){$(this).children().find(a).css("display","none");}}});}function comment_share_to_sina(a){$(a).click(function(){if($(this).hasClass("icon-rightframe")){var b="no";$("#comments .comment_share i.check").removeClass("icon-rightframe");}else{var b="yes";$("#comments .comment_share i.check").addClass("icon-rightframe");}$.ajax({type:"POST",url:"/ajax_set_weibo_connect",data:"isconnect="+b,dataType:"json",success:function(c){}});});return false;}