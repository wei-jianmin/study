https://blog.csdn.net/baidu_37964071/article/details/80514340

一个新搭建好的网络，往往需要先进行一个简单的测试，来验证网络是否畅通
如果丢包了，IP协议并不能通知传输层是否丢包以及丢包的原因。
所以我们就需要一种协议来完成这样的功能CICMP协议

ICMP协议的功能
ICMP协议的功能主要有：
1. 确认IP包是否成功到达目标地址
2. 通知在发送过程中IP包被丢弃的原因

我们需要注意几点
1.ICMP是基于IP协议工作的，但是它并不是传输层的功能，因此仍然把它归结为网络层协议
2. ICMP只能搭配IPv4使用，如果是IPv6的情况下, 需要是用ICMPv6

ICMP的报文格式
    ICMP报文包含在IP数据报中，IP报头在ICMP报文的最前面。
    一个ICMP报文包括IP报头（至少20字节）、ICMP报头（至少八字节）和ICMP报文（属于ICMP报文的数据部分）。
    当IP报头中的协议字段值为1时，就说明这是一个ICMP报文。
    ICMP报头如下所示:
        ---------------------------------
        0      7         15
        ---------------------------------
        类型   代码      校验和
        ---------------------------------
        不同类型和代码，有不同的内容
        ---------------------------------
    说明：
        类型	占一字节，标识ICMP报文的类型，从类型值来看ICMP报文可以分为两大类。
                第一类是取值为1~127的差错报文，第2类是取值128以上的信息报文
        代码	占一字节，标识对应ICMP报文的代码。它与类型字段一起共同标识了ICMP报文的详细类型
        校验和	这是对包括ICMP报文数据部分在内的整个ICMP数据报的校验和，
                以检验报文在传输过程中是否出现了差错（其计算方法与在我们介绍IP报头中的校验和计算方法是一样的）

ICMP大概分为两类报文：一类是通知出错原因、一类是用于诊断查询
类型及含义如下：
    类型（十进制）	内容
    0	            回送ping应答
    3	            目标不可达
    4	            原点抑制
    5	            重定向或改变路由
    8	            回送ping请求
    9	            路由器公告
    10	            路由器请求
    11	            超时
    17	            地址子网请求
    18	            地址子网应答
    
常见的ICMP报文
    响应ping请求
        我们用的ping操作中就包括了相应请求（类型字段值为8）和应答（类型字段值为0）ICMP报文。
        过程：
            一台主机向一个节点发送一个类型字段值为8的ICMP报文，
            如果途中没有异常（如果没有被路由丢弃，目标不回应ICMP或者传输失败），
            则目标返回类型字段值为0的ICMP报文，说明这台主机存在。
    目标不可达，源抑制和超时报文
        这三种报文的格式是一样的。
        （1）目标不可到达报文（类型值为3）在路由器或者主机不能传递数据时使用。
             例如：我们要连接对方一个不存在的系统端口（端口号小于1024）时（？？），将返回类型字段值3、代码字段值为3的ICMP报文。
             常见的不可到达类型还有
                网络不可到达（代码字段值为0）、
                主机不可达到（代码字段值为1）、
                协议不可到达（代码字段值为2）等等。
        （2）源抑制报文（类型字段值为4，代码字段值为0）则充当一个控制流量的角色，通知主机减少数据报流量。
             由于ICMP没有回复传输的报文，所以只要停止该报文，主机就会逐渐恢复传输速率。
        （3）无连接方式网络的问题就是数据报会丢失，
             或者长时间在网络游荡而找不到目标，
             或者拥塞导致主机在规定的时间内无法重组数据报分段，
             这时就要触发ICMP超时报文的产生。
             超时报文（类型字段值为11）的代码域有两种取值：
             代码字段值为0表示传输超时，代码字段值为1表示分段重组超时。
    时间戳请求
        时间戳请求报文（类型值字段13）和时间戳应答报文（类型值字段14）
        用于测试两台主机之间数据报来回一次的传输时间。
        传输时，主机填充原始时间戳，
        接受方收到请求后填充接受时间戳后以类型值字段14的报文格式返回，发送方计算这个时间差。
        (有些系统不响应这种报文)
    重定向
            拓扑：
                   参： file://icmp重定向包测试.pkt
                   R1                  R2  ━━━━━   资源服务器
                    ┃                    ┃
                    ┗      交换机   ┛
                               ┃
                            主机
                    一个主机，通过交换机，分别连接了路由器R1、R2的1口，
                    而要请求的资源在 R2 后面（2口上）
             主机配置：
                    正常，应该设置主机路由，让请求的包，发给 R2，然后 R2 再转发该请求
                    但此处配置主机的路由，使之在访问资源时，把数据包发给 R1
             数据包流经线路：
                    主机请求资源的包，会先发到 R1 的 1 口上，
                    R1 内部根据路由表，确定应该从哪个口发出
                    结果 R1 发现要请求的资源，还是应该从1口发出，目的地 R2，
                    于是 R1 会把该包的源mac换为自己的mac，把目标mac换为R2的1口的mac，
                    重新发出该包（因为数据包从1口进，从1口出，所以不处理ip层），
                    该包到达 R2 的 1 口后，根据目标ip，进行 ip 层源ip、目的ip替换后，
                    从 R2 的 2 口上发出，最终到达资源服务器
                    资源服务器回应的包，到达 R2 的 2 口后，根据 nat 转换关系，
                    将目的 ip 换为主机的 ip，将源 ip，换为 1 口的 ip，
                    处理完 ip 层后，还要处理链路层，根据路由器中的 arp 表，
                    查出目的 ip 对应的 mac 地址（主机的mac）作为目的 mac，
                    同时 R2 的 1 口的 mac 作为源 mac，
                    可知，此时从 1 口发出的响应包，将直接达到主机，不会再经过 R1 的中转了
            路由器额外的行为：
                    因为路由器 R2 发现从1口上收到的数据包，还得从1口上发出去，
                    这表明 PC 不经过自己的中转，肯定也能直接发给 R1，
                    所以 R2 就会给主机发送 icmp 重定向包，告知其应该把数据包发给 R1,
                    主机收到该重定向包后，会动态修改路由，之后发的包，将直接去往 R1 了
                    注：在思科模拟器中，没看到从R2发出的重定向包（默认没开启重定向）
            例二：
                    再如，让 PC1 开启转发，把 PC2 原来的网关为路由器，现在设为 PC1， 
                    则 PC2 发出的包，会经由 PC1 发往路由器，（PC1 会做链路层处理）
                    路由器收到该包后，会根据目的ip，做ip层转换后，从别的口发出
                    待路由器收到请求后，会做反向ip层转换，转换后的目的ip，为PC2，
                    然后路由器会查arp，获得PC2的mac，从而将回应包直接发给 PC2
                    与此同时，PC1处理转发PC2的包外，还会给PC2发重定向包，
                    使PC2动态修改路由：以后发同样ip请求的包使，不要再让我中转了，
                    你直接发给我告诉你的这个路由器就行
                    所以，可见光打开PC1的转发功能，PC1是没法真正完成PC2的代理功能的，
                    还需要设置iptables，修改转发出的包的源ip，为PC1自己的ip，
                    这样，PC1就不会给PC2发重定向包了
            重定向包所携带的数据内容格式：
                    Byte 0      Byte 1      Byte 2      Byte 3
                    类型         代码        校验和     
                    重定向网关 IP
                    原包的IP首部
                    源IP数据报前8个字节
                    注：
                            重定向报文的类型为5，代码有效值为0到3。
                            其中0代表网络重定向，1代表主机重定向，
                            2代表服务类型和网络重定向，3代表服务类型和主机重定向。
                            原则上，重定向报文是由路由器产生而供主机使用的。
                            路由器默认发送的重定向报文也只是1或者3，
                            只是对主机的重定向，而不是对网络的重定向。
                            而主机本身不是路由器，所以这种ICMP重定向会导致网络流量的增大。
                    对于路由器来说，只有当如下条件同时满足的时候，才进行重定向：
                            a)  数据包的入接口和路由后的指定的出接口是同一个接口。
                            b)  数据包的源IP地址和该包应走的下一跳IP地址属于同一个网段。
                            c)  数据报非源路由的（这种情况应该比较少见了，源路由多见于Token Ring）。
                            d)  系统开启重定向功能。
            
